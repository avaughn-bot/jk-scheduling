// ============================================
// JK SCHEDULING SYSTEM - GOOGLE APPS SCRIPT (FIXED)
// ============================================

const TEAMS_SHEET = 'Teams';
const ASSIGNMENTS_SHEET = 'Assignments';

// ============================================
// MAIN HANDLER - Routes all GET requests
// ============================================
function doGet(e) {
  try {
    const action = e && e.parameter ? e.parameter.action : null;
    
    if (!action) {
      return jsonResponse({ error: 'No action specified' });
    }
    
    switch(action) {
      case 'loadTeams':
        return jsonResponse(loadTeams());
      case 'loadAssignments':
        return jsonResponse(loadAssignments());
      default:
        return jsonResponse({ error: 'Invalid action: ' + action });
    }
  } catch (error) {
    return jsonResponse({ error: error.toString() });
  }
}

// ============================================
// MAIN HANDLER - Routes all POST requests
// ============================================
function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      return jsonResponse({ error: 'No data provided' });
    }
    
    const params = JSON.parse(e.postData.contents);
    const action = params.action;
    
    if (!action) {
      return jsonResponse({ error: 'No action specified' });
    }
    
    switch(action) {
      case 'saveAssignment':
        return jsonResponse(saveAssignment(params));
      case 'deleteAssignment':
        return jsonResponse(deleteAssignment(params));
      case 'saveTeams':
        return jsonResponse(saveTeams(params.teams));
      default:
        return jsonResponse({ error: 'Invalid action: ' + action });
    }
  } catch (error) {
    return jsonResponse({ error: error.toString() });
  }
}

// ============================================
// TEAMS FUNCTIONS
// ============================================
function loadTeams() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(TEAMS_SHEET);
  
  if (!sheet) {
    return { error: 'Teams sheet not found' };
  }
  
  const data = sheet.getDataRange().getValues();
  
  const teams = {};
  for (let i = 1; i < data.length; i++) {
    const [teamName, staffName, staffRole] = data[i];
    
    if (!teamName || !staffName) continue;
    
    if (!teams[teamName]) {
      teams[teamName] = [];
    }
    
    teams[teamName].push({
      name: staffName,
      role: staffRole || ''
    });
  }
  
  return teams;
}

function saveTeams(teamsData) {
  if (!teamsData) {
    return { error: 'No teams data provided' };
  }
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(TEAMS_SHEET);
  
  if (!sheet) {
    return { error: 'Teams sheet not found' };
  }
  
  // Clear existing data (except header)
  const lastRow = sheet.getLastRow();
  if (lastRow > 1) {
    sheet.deleteRows(2, lastRow - 1);
  }
  
  // Convert teams object to rows
  const rows = [];
  for (const teamName in teamsData) {
    const members = teamsData[teamName];
    members.forEach(member => {
      rows.push([teamName, member.name, member.role || '']);
    });
  }
  
  // Write to sheet
  if (rows.length > 0) {
    sheet.getRange(2, 1, rows.length, 3).setValues(rows);
  }
  
  return { success: true, rowsWritten: rows.length };
}

// ============================================
// ASSIGNMENTS FUNCTIONS
// ============================================
function loadAssignments() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ASSIGNMENTS_SHEET);
  
  if (!sheet) {
    return { error: 'Assignments sheet not found' };
  }
  
  const data = sheet.getDataRange().getValues();
  
  const assignments = {};
  for (let i = 1; i < data.length; i++) {
    const [staffName, date, location, task, desk, classification, clientName] = data[i];
    
    if (!staffName || !date) continue;
    
    const dateStr = formatDate(date);
    const key = `${staffName}-${dateStr}`;
    
    assignments[key] = {
      location: location || '',
      task: task || '',
      desk: desk || '',
      classification: classification || 'Audit',
      clientName: clientName || ''
    };
  }
  
  return assignments;
}

function saveAssignment(params) {
  if (!params || !params.key || !params.assignment) {
    return { error: 'Missing key or assignment data' };
  }
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ASSIGNMENTS_SHEET);
  
  if (!sheet) {
    return { error: 'Assignments sheet not found' };
  }
  
  const key = params.key;
  const assignment = params.assignment;
  
  // Split the key to get staff name and date
  // Key format is "StaffName-YYYY-MM-DD"
  const lastDashIndex = key.lastIndexOf('-');
  const secondLastDashIndex = key.lastIndexOf('-', lastDashIndex - 1);
  const thirdLastDashIndex = key.lastIndexOf('-', secondLastDashIndex - 1);
  
  const staffName = key.substring(0, thirdLastDashIndex);
  const dateStr = key.substring(thirdLastDashIndex + 1);
  
  if (!staffName || !dateStr) {
    return { error: 'Invalid key format: ' + key };
  }
  
  // Convert YYYY-MM-DD string to a proper Date object
  const dateParts = dateStr.split('-');
  if (dateParts.length !== 3) {
    return { error: 'Invalid date format. Expected YYYY-MM-DD, got: ' + dateStr };
  }
  
  const year = parseInt(dateParts[0]);
  const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed in JavaScript
  const day = parseInt(dateParts[2]);
  const dateObj = new Date(year, month, day);
  
  // Check if assignment already exists
  const existingRow = findAssignmentRow(staffName, dateStr);
  
  const rowData = [
    staffName,
    dateObj, // Store as Date object, not string!
    assignment.location || '',
    assignment.task || '',
    assignment.desk || '',
    assignment.classification || 'Audit',
    assignment.clientName || ''
  ];
  
  if (existingRow > 0) {
    // Update existing row
    sheet.getRange(existingRow, 1, 1, 7).setValues([rowData]);
  } else {
    // Append new row
    sheet.appendRow(rowData);
  }
  
  return { success: true, key: key };
}

function deleteAssignment(params) {
  if (!params || !params.key) {
    return { error: 'Missing key' };
  }
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ASSIGNMENTS_SHEET);
  
  if (!sheet) {
    return { error: 'Assignments sheet not found' };
  }
  
  const key = params.key;
  const [staffName, dateStr] = key.split('-');
  
  if (!staffName || !dateStr) {
    return { error: 'Invalid key format' };
  }
  
  const row = findAssignmentRow(staffName, dateStr);
  
  if (row > 0) {
    sheet.deleteRow(row);
    return { success: true, key: key };
  }
  
  return { success: false, message: 'Assignment not found' };
}

function findAssignmentRow(staffName, dateStr) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ASSIGNMENTS_SHEET);
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    const [sheetStaffName, sheetDate] = data[i];
    const sheetDateStr = formatDate(sheetDate);
    
    if (sheetStaffName === staffName && sheetDateStr === dateStr) {
      return i + 1;
    }
  }
  
  return -1;
}

// ============================================
// UTILITY FUNCTIONS
// ============================================
function formatDate(date) {
  if (typeof date === 'string' && date.match(/^\d{4}-\d{2}-\d{2}$/)) {
    return date;
  }
  
  const d = new Date(date);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function jsonResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// ============================================
// INITIALIZATION FUNCTION
// ============================================
function setupSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // Create Teams sheet if it doesn't exist
  let teamsSheet = ss.getSheetByName(TEAMS_SHEET);
  if (!teamsSheet) {
    teamsSheet = ss.insertSheet(TEAMS_SHEET);
    teamsSheet.appendRow(['TeamName', 'StaffName', 'StaffRole']);
    teamsSheet.getRange('A1:C1').setFontWeight('bold');
  }
  
  // Create Assignments sheet if it doesn't exist
  let assignmentsSheet = ss.getSheetByName(ASSIGNMENTS_SHEET);
  if (!assignmentsSheet) {
    assignmentsSheet = ss.insertSheet(ASSIGNMENTS_SHEET);
    assignmentsSheet.appendRow(['StaffName', 'AssignmentDate', 'Location', 'Task', 'Desk', 'Classification', 'ClientName']);
    assignmentsSheet.getRange('A1:G1').setFontWeight('bold');
  }
  
  Logger.log('Sheets setup complete!');
  return 'Setup complete!';
}
